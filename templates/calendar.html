{% extends "base.html" %}
{% block content %}
<div class="calendar-container">
    <h1>Календарь отпусков {{ year }}</h1>

    <form method="GET" action="{{ url_for('calendar') }}" class="year-selector">
        <label>Год:</label>
        <input type="number" name="year" value="{{ year }}" min="2000" max="2100" required>
        <button type="submit" class="btn btn-primary">Перейти</button>
    </form>

    {% if warning %}
    <div class="warning">
        Нужно выбрать еще {{ 4 - taken_count }} недель из 4!
    </div>
    {% endif %}

    {% if can_edit %}
    <div class="stats">
        Ваши отпуска в {{ year }} году: {{ taken_count }}/4
    </div>
    {% endif %}

    <div class="weeks-grid">
        {% for week in weeks %}
        <div class="week-card
                {% if week.num in user_vacations %}your-vacation
                {% elif week.owner %}taken
                {% endif %}">

            <div>
                <div class="week-header">
                    <strong>Неделя {{ week.num }}</strong>
                </div>

                <div class="week-dates">
                    {{ week.start.strftime('%d.%m') }} — {{ week.end.strftime('%d.%m.%Y') }}
                </div>
            </div>

            <div class="week-status">
                {# --- РЕЖИМ ПРОСМОТРА: прошлые/будущие годы, или админ --- #}
                {% if not can_edit %}
                {% if week.owner %}
                <span class="status-taken">Занято: {{ week.owner | short_name }}</span>
                {% else %}
                <span class="status-past">Свободно</span>
                {% endif %}

                {# --- РЕЖИМ РЕДАКТИРОВАНИЯ: только текущий год и не админ --- #}
                {% else %}
                {% if week.owner and (week.num not in user_vacations) %}
                <span class="status-taken">Занято: {{ week.owner | short_name }}</span>

                {% elif week.num in user_vacations %}
                <form method="POST" action="{{ url_for('toggle_vacation') }}" class="inline-form">
                    <input type="hidden" name="year" value="{{ year }}">
                    <input type="hidden" name="week" value="{{ week.num }}">
                    <button type="submit" class="btn btn-remove">Снять отпуск</button>
                </form>

                {% else %}
                <form method="POST" action="{{ url_for('toggle_vacation') }}" class="inline-form">
                    <input type="hidden" name="year" value="{{ year }}">
                    <input type="hidden" name="week" value="{{ week.num }}">
                    <button type="submit" class="btn btn-take">Взять отпуск</button>
                </form>
                {% endif %}
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
